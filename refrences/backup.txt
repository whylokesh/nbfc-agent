import os
from dotenv import load_dotenv
from langchain_openai import ChatOpenAI
from langchain_community.utilities import SQLDatabase
from langchain_community.agent_toolkits import SQLDatabaseToolkit
from langchain.agents import initialize_agent, AgentType
from langchain.tools import Tool


# ============================================================
# üîß Load environment variables
# ============================================================
load_dotenv()

OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
DB_URI = os.getenv("DB_URI")

if not OPENAI_API_KEY:
    raise ValueError("‚ùå Missing environment variable: OPENAI_API_KEY")

if not DB_URI:
    raise ValueError("‚ùå Missing environment variable: DB_URI")

os.environ["OPENAI_API_KEY"] = OPENAI_API_KEY


# ============================================================
# üß† Initialize Database & LLM
# ============================================================
db = SQLDatabase.from_uri(DB_URI)
llm = ChatOpenAI(model="gpt-4o", temperature=0)

# ============================================================
# üß∞ Tool 1: SQL Querying (RAG)
# ============================================================
toolkit = SQLDatabaseToolkit(db=db, llm=llm)
sql_tools = toolkit.get_tools()  # contains `query_sql_db`, `info_sql_db`, etc.

# ============================================================
# üß∞ Tool 2: Ping Sales Team
# ============================================================
def ping_sales_team(lead_id: str, message: str):
    """
    Simulates sending a message to the sales team.
    In real use: integrate Twilio, Slack, or WhatsApp APIs.
    """
    print(f"üì® Sales Team Notified ‚Üí Lead ID: {lead_id} | Message: {message}")
    return f"‚úÖ Sales team notified for Lead {lead_id}: '{message}'"

ping_tool = Tool(
    name="ping_sales_team",
    func=ping_sales_team,
    description=(
        "Send a message to the sales team about a specific lead. "
        "Use this when the user wants to follow up or alert sales. "
        "Inputs: 'lead_id' (string) and 'message' (string)."
    )
)

# ============================================================
# ü§ñ Create Context-Aware Agent
# ============================================================
AGENT_SYSTEM_PROMPT = """
You are NBFC AI Assistant ‚Äî an intelligent sales and data assistant for a financial company.
You can:
- Analyze and query lead or customer data from the PostgreSQL database.
- Retrieve insights like top leads, pending applications, or rejected cases.
- Ping the sales team for follow-ups or urgent cases.

When users ask something, do the following:
1. If it's a data-related query, use the database tools.
2. If it‚Äôs a task (e.g., follow-up, alert), use the ping_sales_team tool.
3. Always explain what you found or did in a clear, business-style tone.
"""

agent = initialize_agent(
    tools=sql_tools + [ping_tool],
    llm=llm,
    agent_type=AgentType.OPENAI_FUNCTIONS,  # enables structured tool calling
    verbose=True,
    agent_kwargs={"system_message": AGENT_SYSTEM_PROMPT},
)

# ============================================================
# üí¨ Interactive Loop
# ============================================================
print("\nü§ñ NBFC AI Assistant Ready!")
print("Type 'exit' to quit.\n")

while True:
    user_input = input("You: ")
    if user_input.lower() in ["exit", "quit"]:
        break

    try:
        response = agent.invoke({"input": user_input})
        print("\nAssistant:", response["output"], "\n")
    except Exception as e:
        print("‚ö†Ô∏è Error:", e)
